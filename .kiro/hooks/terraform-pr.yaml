name: "Terraform PR"
description: "Create PR specifically for Terraform changes with plan output"
trigger: "manual"
command: "/tfpr"
script: |
  #!/bin/bash
  
  # Terraform ë³€ê²½ì‚¬í•­ë§Œ í™•ì¸
  TF_CHANGES=$(git status --porcelain | grep -E '\.(tf|tfvars)$')
  
  if [[ -z "$TF_CHANGES" ]]; then
      echo "âŒ No Terraform changes detected."
      exit 1
  fi
  
  echo "ğŸ” Terraform changes detected:"
  echo "$TF_CHANGES"
  
  # ë¸Œëœì¹˜ ìƒì„±
  BRANCH_NAME="terraform/$(date +"%Y%m%d-%H%M%S")"
  echo "ğŸŒ¿ Creating branch: $BRANCH_NAME"
  git checkout -b "$BRANCH_NAME"
  
  # ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
  git add .
  
  # ë³€ê²½ëœ Terraform ë””ë ‰í† ë¦¬ ì°¾ê¸°
  TF_DIRS=$(git diff --cached --name-only | grep '\.tf$' | xargs -I {} dirname {} | sort -u)
  
  # ì»¤ë°‹
  COMMIT_MSG="feat(terraform): update infrastructure configuration"
  git commit -m "$COMMIT_MSG"
  
  # í‘¸ì‹œ
  git push -u origin "$BRANCH_NAME"
  
  # Terraform plan ì‹¤í–‰ (ì„ íƒì )
  PLAN_OUTPUT=""
  for dir in $TF_DIRS; do
      if [[ -f "$dir/main.tf" || -f "$dir/provider.tf" ]]; then
          echo "ğŸ”§ Running terraform plan in $dir..."
          cd "$dir"
          if terraform init -backend=false &>/dev/null; then
              PLAN_RESULT=$(terraform plan -no-color 2>&1 | head -50)
              PLAN_OUTPUT+="
  ### Plan for $dir
  \`\`\`
  $PLAN_RESULT
  \`\`\`
  "
          fi
          cd - &>/dev/null
      fi
  done
  
  # PR ìƒì„±
  PR_DESCRIPTION="## ğŸ—ï¸ Terraform Infrastructure Changes
  
  ### ğŸ“ Modified Directories
  $(echo "$TF_DIRS" | sed 's/^/- /')
  
  ### ğŸ“‹ Changed Files
  $(git diff --name-only HEAD~1 | grep -E '\.(tf|tfvars)$' | sed 's/^/- /')
  
  $PLAN_OUTPUT
  
  ### âœ… Checklist
  - [ ] Terraform plan reviewed
  - [ ] Resource changes validated
  - [ ] Security implications checked
  - [ ] Atlantis workflow ready
  
  ---
  *Generated by Terraform PR Hook*"
  
  gh pr create \
      --title "$COMMIT_MSG" \
      --body "$PR_DESCRIPTION" \
      --base main \
      --label "terraform,infrastructure"
  
  echo "âœ… Terraform PR created successfully!"