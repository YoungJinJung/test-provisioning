name: "Auto Create PR"
description: "Create branch, commit changes, and create PR with auto-generated description"
trigger: "manual"
command: "/create-pr"
script: |
  #!/bin/bash
  
  # 1. í˜„ì¬ ìƒíƒœ í™•ì¸
  echo "ğŸ” Checking current git status..."
  git status --porcelain
  
  # 2. ë³€ê²½ëœ íŒŒì¼ë“¤ í™•ì¸
  CHANGED_FILES=$(git diff --name-only HEAD)
  STAGED_FILES=$(git diff --cached --name-only)
  UNTRACKED_FILES=$(git ls-files --others --exclude-standard)
  
  if [[ -z "$CHANGED_FILES" && -z "$STAGED_FILES" && -z "$UNTRACKED_FILES" ]]; then
      echo "âŒ No changes detected. Nothing to commit."
      exit 1
  fi
  
  # 3. ë¸Œëœì¹˜ëª… ìë™ ìƒì„± (íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜)
  TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
  BRANCH_NAME="feature/auto-pr-${TIMESTAMP}"
  
  echo "ğŸŒ¿ Creating new branch: $BRANCH_NAME"
  git checkout -b "$BRANCH_NAME"
  
  # 4. ëª¨ë“  ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
  echo "ğŸ“¦ Staging all changes..."
  git add .
  
  # 5. ë³€ê²½ëœ íŒŒì¼ ë¶„ì„ ë° ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
  echo "ğŸ“ Analyzing changes for commit message..."
  
  # Terraform íŒŒì¼ ë³€ê²½ ê°ì§€
  TF_CHANGES=$(git diff --cached --name-only | grep -E '\.(tf|tfvars)$' | wc -l)
  YAML_CHANGES=$(git diff --cached --name-only | grep -E '\.(yaml|yml)$' | wc -l)
  CONFIG_CHANGES=$(git diff --cached --name-only | grep -E '\.(json|conf|config)$' | wc -l)
  
  # ì»¤ë°‹ ë©”ì‹œì§€ ìë™ ìƒì„±
  if [[ $TF_CHANGES -gt 0 ]]; then
      COMMIT_TYPE="feat(terraform)"
      COMMIT_MSG="Update terraform infrastructure configuration"
  elif [[ $YAML_CHANGES -gt 0 ]]; then
      COMMIT_TYPE="feat(config)"
      COMMIT_MSG="Update YAML configuration files"
  elif [[ $CONFIG_CHANGES -gt 0 ]]; then
      COMMIT_TYPE="feat(config)"
      COMMIT_MSG="Update configuration files"
  else
      COMMIT_TYPE="feat"
      COMMIT_MSG="Update project files"
  fi
  
  # 6. ì»¤ë°‹ ì‹¤í–‰
  echo "ğŸ’¾ Committing changes..."
  git commit -m "$COMMIT_TYPE: $COMMIT_MSG"
  
  # 7. ë¸Œëœì¹˜ í‘¸ì‹œ
  echo "ğŸš€ Pushing branch to remote..."
  git push -u origin "$BRANCH_NAME"
  
  # 8. ë³€ê²½ì‚¬í•­ ìƒì„¸ ë¶„ì„ (PR Descriptionìš©)
  echo "ğŸ“Š Generating PR description..."
  
  # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
  CHANGED_FILES_LIST=$(git diff --name-only HEAD~1)
  ADDED_FILES=$(git diff --name-status HEAD~1 | grep "^A" | cut -f2)
  MODIFIED_FILES=$(git diff --name-status HEAD~1 | grep "^M" | cut -f2)
  DELETED_FILES=$(git diff --name-status HEAD~1 | grep "^D" | cut -f2)
  
  # PR Description ìƒì„±
  PR_DESCRIPTION="## ğŸ”„ Changes Summary
  
  ### ğŸ“‹ Modified Files"
  
  if [[ -n "$MODIFIED_FILES" ]]; then
      PR_DESCRIPTION+="
  $(echo "$MODIFIED_FILES" | sed 's/^/- /')"
  else
      PR_DESCRIPTION+="
  - None"
  fi
  
  PR_DESCRIPTION+="
  
  ### â• Added Files"
  
  if [[ -n "$ADDED_FILES" ]]; then
      PR_DESCRIPTION+="
  $(echo "$ADDED_FILES" | sed 's/^/- /')"
  else
      PR_DESCRIPTION+="
  - None"
  fi
  
  PR_DESCRIPTION+="
  
  ### âŒ Deleted Files"
  
  if [[ -n "$DELETED_FILES" ]]; then
      PR_DESCRIPTION+="
  $(echo "$DELETED_FILES" | sed 's/^/- /')"
  else
      PR_DESCRIPTION+="
  - None"
  fi
  
  PR_DESCRIPTION+="
  
  ### ğŸ—ï¸ Infrastructure Changes"
  
  # Terraform ë³€ê²½ì‚¬í•­ ìƒì„¸ ë¶„ì„
  if [[ $TF_CHANGES -gt 0 ]]; then
      PR_DESCRIPTION+="
  - **Terraform files updated**: $TF_CHANGES files
  - **Resources affected**: $(git diff --cached --name-only | grep '\.tf$' | xargs -I {} basename {} .tf | tr '\n' ', ' | sed 's/,$//')"
  fi
  
  # Atlantis ì„¤ì • í™•ì¸
  if echo "$CHANGED_FILES_LIST" | grep -q "atlantis.yaml"; then
      PR_DESCRIPTION+="
  - **Atlantis configuration updated**"
  fi
  
  PR_DESCRIPTION+="
  
  ### ğŸ” Review Checklist
  - [ ] Terraform plan reviewed
  - [ ] Security implications considered  
  - [ ] Documentation updated if needed
  - [ ] Tests passing
  
  ---
  *Auto-generated PR from Kiro Hook*"
  
  # 9. GitHub CLIë¡œ PR ìƒì„±
  echo "ğŸ¯ Creating pull request..."
  
  # PR ì œëª© ìƒì„±
  PR_TITLE="$COMMIT_TYPE: $COMMIT_MSG"
  
  # PR ìƒì„± (ë¦¬ë·°ì–´ ìë™ í• ë‹¹ ì˜µì…˜)
  gh pr create \
      --title "$PR_TITLE" \
      --body "$PR_DESCRIPTION" \
      --base main \
      --head "$BRANCH_NAME" \
      --draft=false
  
  echo "âœ… PR created successfully!"
  echo "ğŸ”— View PR: $(gh pr view --web)"